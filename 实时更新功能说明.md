# 聊天页面实时更新功能说明

## 已实现的功能

### 1. WebSocket 实时通信 ✅

- **自动连接**: 用户登录后，在进入聊天页面时自动建立 WebSocket 连接
- **断线重连**: 连接断开后，5秒后自动尝试重连
- **连接状态**: 页面左上角有绿色/红色指示器，显示 WebSocket 连接状态
  - 🟢 绿色 = 已连接（实时更新）
  - 🔴 红色 = 未连接

### 2. 实时接收消息 ✅

**自动更新内容**：
- ✅ 收到新消息时，聊天列表自动更新
- ✅ 如果当前正在查看该会话，消息自动显示在聊天窗口
- ✅ 未读消息数量实时更新
- ✅ 会话自动移到列表顶部（置顶会话除外）
- ✅ 自动滚动到最新消息

**智能处理**：
- 如果正在查看的会话收到消息 → 自动标记为已读
- 如果不在查看的会话收到消息 → 增加未读数
- 新会话消息 → 自动刷新会话列表

### 3. 操作后立即生效 ✅

**置顶聊天**：
- 点击置顶/取消置顶后，列表立即重新排序
- 置顶的会话自动移到最前面
- 无需刷新页面

**消息免打扰**：
- 设置后立即生效
- 状态在会话列表中实时显示

**清空聊天记录**：
- 清空后，聊天窗口立即清空
- 会话列表中的最后一条消息也清空
- 无需手动刷新

### 4. 发送消息优化 ✅

- 发送消息时，立即显示在聊天窗口（乐观更新）
- 发送成功后，WebSocket 会推送给对方
- 发送失败时，自动从列表中移除临时消息

## 技术实现

### WebSocket 连接

```javascript
// 连接地址
ws://localhost:8080/ws/chat?token={JWT_TOKEN}

// 消息格式
{
  "type": "chat" | "message" | "notification",
  "conversationId": 123,
  "senderId": 456,
  "content": "消息内容",
  "contentType": "text",
  "createdAt": "2025-12-25T10:00:00"
}
```

### 自动重连机制

```javascript
websocket.onclose = () => {
  // 5秒后自动重连
  setTimeout(() => {
    if (authStore.token) {
      initWebSocket();
    }
  }, 5000);
};
```

### 实时消息处理

```javascript
handleWebSocketMessage(message) {
  // 1. 更新会话列表
  // 2. 更新未读数
  // 3. 移动会话到顶部
  // 4. 如果正在查看，添加到消息列表
  // 5. 自动滚动到底部
}
```

## 使用说明

### 测试实时更新

1. **测试消息接收**：
   - 打开两个浏览器窗口
   - 分别登录两个不同的账号
   - 在一个窗口发送消息
   - 另一个窗口会自动显示消息（无需刷新）

2. **测试置顶功能**：
   - 点击会话右侧的"⋮"菜单
   - 点击"置顶聊天"
   - 会话立即移到列表最上方

3. **测试免打扰**：
   - 点击"消息免打扰"
   - 状态立即生效

4. **测试清空记录**：
   - 点击"清空聊天记录"
   - 确认后，聊天窗口立即清空

### 查看连接状态

- 打开浏览器控制台（F12）
- 查看 Console 标签页
- 会看到以下日志：
  - ✅ `正在建立WebSocket连接`
  - ✅ `WebSocket连接成功`
  - ✅ `收到WebSocket消息`
  - ✅ `处理WebSocket消息`

## 常见问题

### Q: 没有自动更新？

**检查步骤**：
1. 查看页面左上角的连接状态指示器是否为绿色
2. 打开控制台，检查是否有错误信息
3. 确认后端 WebSocket 服务是否运行（端口 8080）
4. 检查 JWT Token 是否有效

### Q: WebSocket 一直显示红色？

**可能原因**：
1. 后端服务未启动
2. Token 已过期，需要重新登录
3. 网络连接问题
4. 防火墙阻止 WebSocket 连接

**解决方法**：
1. 确认后端服务正在运行
2. 退出登录，重新登录获取新 Token
3. 检查浏览器控制台的错误信息

### Q: 消息延迟？

**正常情况**：
- WebSocket 连接正常时，消息应该在 1 秒内送达
- 如果延迟超过 3 秒，检查网络连接

### Q: 置顶后没有立即生效？

**检查**：
- 确认操作成功（控制台应该有成功日志）
- 如果有多个置顶会话，它们会按时间排序
- 刷新页面后应该保持置顶状态

## 开发者信息

### 修改的文件

1. `src/views/ChatPage.vue`
   - 添加 WebSocket 连接逻辑
   - 添加实时消息处理
   - 优化操作后的 UI 更新

### 新增功能函数

- `initWebSocket()` - 初始化 WebSocket 连接
- `handleWebSocketMessage()` - 处理接收到的消息
- `closeWebSocket()` - 关闭连接

### 优化的函数

- `togglePin()` - 添加自动排序
- `toggleMute()` - 添加状态提示
- `clearChatHistory()` - 添加自动更新
- `sendMessage()` - 优化消息发送流程

## 后续优化建议

1. **消息确认机制**：
   - 添加消息发送状态（发送中、已发送、已读）
   - 显示消息发送失败的原因

2. **离线消息**：
   - 用户上线时，自动拉取离线消息
   - 显示离线消息数量

3. **输入状态**：
   - 显示"对方正在输入..."
   - 通过 WebSocket 推送输入状态

4. **消息推送通知**：
   - 浏览器原生通知
   - 声音提示

5. **消息撤回**：
   - 2分钟内可撤回消息
   - 实时同步撤回状态

---

**更新时间**: 2025-12-25  
**版本**: v1.0
